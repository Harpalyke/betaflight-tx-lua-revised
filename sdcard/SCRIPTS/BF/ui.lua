local a=assert(loadScript(SCRIPT_HOME.."/events.lua"))()local b={display=2,editing=3,saving=4,displayMenu=5}local c={reboot=68,eepromWrite=250}local d=b.display;local e=80;local f=1;local g=1;local h=0;local i=0;local j=0;local k=0;local l=false;local m=false;local n=false;local o=0;local p=0;SetupPages={}backgroundFill=backgroundFill or ERASE;foregroundColor=foregroundColor or SOLID;globalTextOptions=globalTextOptions or 0;local function q(r)local s=SetupPages[f]if s.values then if s.preSave then s.preSave(s)end;protocol.mspWrite(s.write,s.values)h=getTime()if d==b.saving then j=j+1 else d=b.saving;j=0;k=protocol.saveMaxRetries or 2;i=protocol.saveTimeout or 150 end end end;local function t()SetupPages={}d=b.display;h=0 end;local function u()protocol.mspRead(c.reboot)t()end;local function v()protocol.mspRead(c.eepromWrite)end;local w={{t="save page",f=q},{t="reload",f=t},{t="reboot",f=u}}local function x(y,z)if y==nil or z==nil then return end;local s=SetupPages[f]if y==s.write then if s.eepromWrite then v()end;l=false;return end;if y==c.eepromWrite then if s.reboot then u()end;t()d=b.display;h=0;return end;if y~=s.read then return end;if#z>0 then s.values={}for A=1,#z do s.values[A]=z[A]end;if s.postLoad then s.postLoad(s)end end end;local function B()return#SetupPages[f].fields end;local function C(D)f=f+D;if f>#PageFiles then f=1 elseif f<1 then f=#PageFiles end;g=1 end;local function E(D)g=g+D;if g>B()then g=1 elseif g<1 then g=B()end end;local function F(D)n=n+D;if n>#w then n=1 elseif n<1 then n=#w end end;local function G(s)if s.read and(s.reqTS==nil or s.reqTS+e<=getTime())then s.reqTS=getTime()protocol.mspRead(s.read)end end;function drawScreenTitle(H)lcd.drawFilledRectangle(0,0,LCD_W,10)lcd.drawText(1,1,H,INVERS)end;local function I(s,J)local H=s.title;drawScreenTitle("Betaflight / "..H)for A=1,#s.text do local K=s.text[A]if K.to==nil then lcd.drawText(K.x,K.y,K.t,globalTextOptions)else lcd.drawText(K.x,K.y,K.t,K.to)end end;local L="---"for A=1,#s.fields do local K=s.fields[A]local M=K.to or globalTextOptions;local N=M;local O=M;if A==g then O=M+INVERS;if d==b.editing then O=O+BLINK end end;local P=20;if K.t~=nil then lcd.drawText(K.x,K.y,K.t,N)if K.sp~=nil then P=K.sp end else P=0 end;if s.values then if(#s.values or 0)>=s.minBytes then if not K.value and K.vals then for Q=1,#K.vals do K.value=bit32.bor(K.value or 0,bit32.lshift(s.values[K.vals[Q]],(Q-1)*8))end;K.value=K.value/(K.scale or 1)end end end;if K.value then if K.upd and s.values then K.upd(s)end;L=K.value;if K.table and K.table[K.value]then L=K.table[K.value]end end;lcd.drawText(K.x+P,K.y,L,O)end end;local function R(L,S,T)if L<S then L=S elseif L>T then L=T end;return L end;local function U()local s=SetupPages[f]return s.fields[g]end;local function V(D)local s=SetupPages[f]local K=s.fields[g]local Q=K.i or g;local W=K.scale or 1;K.value=R(K.value+D*(K.mult or 1)/W,K.min/W or 0,K.max/W or 255)for Q=1,#K.vals do s.values[K.vals[Q]]=bit32.rshift(K.value*W,(Q-1)*8)end;if K.upd and s.values then K.upd(s)end end;local function X()local Y=MenuBox.x;local Z=MenuBox.y;local _=MenuBox.w;local a0=MenuBox.h_line;local a1=MenuBox.h_offset;local a2=#w*a0+a1*2;lcd.drawFilledRectangle(Y,Z,_,a2,backgroundFill)lcd.drawRectangle(Y,Z,_-1,a2-1,foregroundColor)lcd.drawText(Y+a0/2,Z+a1,"Menu:",globalTextOptions)for A,a3 in ipairs(w)do local M=globalTextOptions;if n==A then M=M+INVERS end;lcd.drawText(Y+MenuBox.x_offset,Z+(A-1)*a0+a1,a3.t,M)end end;function run_ui(a4)local a5=getTime()if o+50<a5 then t()end;o=a5;if d==b.saving then if h+i<a5 then if j<k then q()else d=b.display;t()end end end;mspProcessTxQ()if a4==a.longPress.menu then n=1;d=b.displayMenu elseif a.press.pageUp and a4==a.longPress.enter then n=1;p=1;d=b.displayMenu elseif d==b.displayMenu then if a4==a.release.exit then d=b.display elseif a4==a.release.plus or a4==a.dial.left then F(-1)elseif a4==a.release.minus or a4==a.dial.right then F(1)elseif a4==a.release.enter then if p==1 then p=0 else d=b.display;w[n].f()end end elseif d<=b.display then if a4==a.press.pageUp then SetupPages[f]=nil;C(-1)elseif a4==a.release.menu or a4==a.press.pageDown then SetupPages[f]=nil;C(1)elseif a4==a.release.plus or a4==a.dial.left then E(-1)elseif a4==a.release.minus or a4==a.dial.right then E(1)elseif a4==a.release.enter then local s=SetupPages[f]local a6=s.fields[g]local Q=a6.i or g;if s.values and s.values[Q]and a6.ro~=true then d=b.editing end elseif a4==a.release.exit then return protocol.exitFunc()end elseif d==b.editing then if a4==a.release.exit or a4==a.release.enter then d=b.display elseif a4==a.press.plus or a4==a.repeatPress.plus or a4==a.dial.right then V(1)elseif a4==a.press.minus or a4==a.repeatPress.minus or a4==a.dial.left then V(-1)end end;if SetupPages[f]==nil then SetupPages[f]=assert(loadScript(radio.templateHome..PageFiles[f]))()end;local J=false;local s=SetupPages[f]if not s.values and d==b.display then G(s)J=true end;lcd.clear()if TEXT_BGCOLOR then lcd.drawFilledRectangle(0,0,LCD_W,LCD_H,TEXT_BGCOLOR)end;I(s,J)if protocol.rssi()==0 then lcd.drawText(NoTelem[1],NoTelem[2],NoTelem[3],NoTelem[4])end;if d==b.displayMenu then X()elseif d==b.saving then lcd.drawFilledRectangle(SaveBox.x,SaveBox.y,SaveBox.w,SaveBox.h,backgroundFill)lcd.drawRectangle(SaveBox.x,SaveBox.y,SaveBox.w,SaveBox.h,SOLID)lcd.drawText(SaveBox.x+SaveBox.x_offset,SaveBox.y+SaveBox.h_offset,"Saving...",DBLSIZE+BLINK+globalTextOptions)end;x(mspPollReply())return 0 end;return run_ui
