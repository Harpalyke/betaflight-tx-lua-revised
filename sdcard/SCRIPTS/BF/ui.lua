local a=assert(loadScript(SCRIPT_HOME.."/events.lua"))()local b=assert(loadScript(SCRIPT_HOME.."/serialize.lua"))()local c={display=2,editing=3,saving=4,displayMenu=5}local d={disconnected=1,notApplied=2,pending=3,applied=4}local e={reboot=68,eepromWrite=250}local f=c.display;local g=d.disconnected;local h=0;local i=80;local j=1;local k=1;local l=0;local m=0;local n=0;local o=0;local p=false;local q=false;local r=false;local s=0;local t=0;Page=nil;backgroundFill=backgroundFill or ERASE;foregroundColor=foregroundColor or SOLID;globalTextOptions=globalTextOptions or 0;local function u(v)if Page.values then if Page.persisted and g==d.applied then b.filename=radio.persistHome..PageFiles[j]b.serialize(b,Page.values)end;if Page.preSave then Page.preSave(Page)end;protocol.mspWrite(Page.write,Page.values)l=getTime()if f==c.saving then n=n+1 else f=c.saving;n=0;o=protocol.saveMaxRetries or 2;m=protocol.saveTimeout or 150 end end end;local function w()Page=nil;f=c.display;l=0 end;local function x()protocol.mspRead(e.reboot)w()end;local function y()protocol.mspRead(e.eepromWrite)end;local z={{t="save page",f=u},{t="reload",f=w},{t="reboot",f=x}}local function A(B,C)if B==nil or C==nil then return end;if B==Page.write then if Page.eepromWrite then y()end;p=false;return end;if B==e.eepromWrite then if Page.reboot then x()end;w()f=c.display;l=0;return end;if B~=Page.read then return end;if#C>0 then Page.values={}for D=1,#C do Page.values[D]=C[D]end;if Page.postLoad then Page.postLoad(Page)end;if g==d.pending then g=d.notApplied end end end;local function E()return#Page.fields end;local function F(G)j=j+G;if j>#PageFiles then j=1 elseif j<1 then j=#PageFiles end;k=1 end;local function H(G)k=k+G;if k>E()then k=1 elseif k<1 then k=E()end end;local function I(G)r=r+G;if r>#z then r=1 elseif r<1 then r=#z end end;local function J()if Page.read and(Page.reqTS==nil or Page.reqTS+i<=getTime())then Page.reqTS=getTime()protocol.mspRead(Page.read)end end;function drawScreenTitle(K)lcd.drawFilledRectangle(0,0,LCD_W,10)lcd.drawText(1,1,K,INVERS)end;local function L()local K=Page.title;drawScreenTitle("Betaflight / "..K)for D=1,#Page.text do local M=Page.text[D]if M.to==nil then lcd.drawText(M.x,M.y,M.t,globalTextOptions)else lcd.drawText(M.x,M.y,M.t,M.to)end end;local N="---"for D=1,#Page.fields do local M=Page.fields[D]local O=M.to or globalTextOptions;local P=O;local Q=O;if D==k then Q=O+INVERS;if f==c.editing then Q=Q+BLINK end end;local R=20;if M.t~=nil then lcd.drawText(M.x,M.y,M.t,P)if M.sp~=nil then R=M.sp end else R=0 end;if Page.values then if(#Page.values or 0)>=Page.minBytes then if not M.value and M.vals then for S=1,#M.vals do M.value=bit32.bor(M.value or 0,bit32.lshift(Page.values[M.vals[S]],(S-1)*8))end;M.value=M.value/(M.scale or 1)end end end;if M.value then if M.upd and Page.values then M.upd(Page)end;N=M.value;if M.table and M.table[M.value]then N=M.table[M.value]end end;lcd.drawText(M.x+R,M.y,N,Q)end end;local function T(N,U,V)if N<U then N=U elseif N>V then N=V end;return N end;local function W()return Page.fields[k]end;local function X(G)local M=Page.fields[k]local S=M.i or k;local Y=M.scale or 1;M.value=T(M.value+G*(M.mult or 1)/Y,M.min/Y or 0,M.max/Y or 255)for S=1,#M.vals do Page.values[M.vals[S]]=bit32.rshift(M.value*Y,(S-1)*8)end;if M.upd and Page.values then M.upd(Page)end end;local function Z()local _=MenuBox.x;local a0=MenuBox.y;local a1=MenuBox.w;local a2=MenuBox.h_line;local a3=MenuBox.h_offset;local a4=#z*a2+a3*2;lcd.drawFilledRectangle(_,a0,a1,a4,backgroundFill)lcd.drawRectangle(_,a0,a1-1,a4-1,foregroundColor)lcd.drawText(_+a2/2,a0+a3,"Menu:",globalTextOptions)for D,a5 in ipairs(z)do local O=globalTextOptions;if r==D then O=O+INVERS end;lcd.drawText(_+MenuBox.x_offset,a0+(D-1)*a2+a3,a5.t,O)end end;function loadPageFile(S)if S<=#PageFiles then Page=assert(loadScript(radio.templateHome..PageFiles[S]))()end end;function checkPersistence()if protocol.rssi()==0 then g=d.disconnected else if g==d.applied then return elseif g==d.disconnected then g=d.notApplied elseif g==d.notApplied then if j==#PageFiles then g=d.applied;j=1;Page=nil;return else Page=nil;F(1)loadPageFile(j)if Page.persisted==true then J()g=d.pending end end elseif g==d.pending then if Page.values and f~=c.saving then if(#Page.values or 0)>=Page.minBytes then local a6=assert(loadScript(radio.persistHome..PageFiles[j]))()if a6 then if Page.applyPersistence(Page,a6)then u()end else g=d.notApplied end end end end end end;function drawSaveBox(a7)lcd.drawFilledRectangle(SaveBox.x,SaveBox.y,SaveBox.w,SaveBox.h,backgroundFill)lcd.drawRectangle(SaveBox.x,SaveBox.y,SaveBox.w,SaveBox.h,SOLID)lcd.drawText(SaveBox.x+SaveBox.x_offset,SaveBox.y+SaveBox.h_offset,a7,DBLSIZE+BLINK+globalTextOptions)end;function run_ui(a8)local a9=getTime()if s+50<a9 then w()end;s=a9;if f==c.saving then if l+m<a9 then if n<o then u()else f=c.display;w()g=d.notApplied end end end;mspProcessTxQ()lcd.clear()if TEXT_BGCOLOR then lcd.drawFilledRectangle(0,0,LCD_W,LCD_H,TEXT_BGCOLOR)end;checkPersistence()if g==d.applied or g==d.disconnected then if a8==a.longPress.menu then r=1;f=c.displayMenu elseif a.press.pageUp and a8==a.longPress.enter then r=1;t=1;f=c.displayMenu elseif f==c.displayMenu then if a8==a.release.exit then f=c.display elseif a8==a.release.plus or a8==a.dial.left then I(-1)elseif a8==a.release.minus or a8==a.dial.right then I(1)elseif a8==a.release.enter then if t==1 then t=0 else f=c.display;z[r].f()end end elseif f<=c.display then if a8==a.press.pageUp then Page=nil;F(-1)elseif a8==a.release.menu or a8==a.press.pageDown then Page=nil;F(1)elseif a8==a.release.plus or a8==a.dial.left then H(-1)elseif a8==a.release.minus or a8==a.dial.right then H(1)elseif a8==a.release.enter then local aa=Page.fields[k]local S=aa.i or k;if Page.values and Page.values[S]and aa.ro~=true then f=c.editing end elseif a8==a.release.exit then return protocol.exitFunc()end elseif f==c.editing then if a8==a.release.exit or a8==a.release.enter then f=c.display elseif a8==a.press.plus or a8==a.repeatPress.plus or a8==a.dial.right then X(1)elseif a8==a.press.minus or a8==a.repeatPress.minus or a8==a.dial.left then X(-1)end end;if Page==nil then loadPageFile(j)end;if not Page.values and f==c.display then J()end;L()end;if protocol.rssi()==0 then lcd.drawText(NoTelem[1],NoTelem[2],NoTelem[3],NoTelem[4])end;if f==c.displayMenu then Z()elseif g==d.pending then drawSaveBox("Syncing...")elseif f==c.saving then drawSaveBox("Saving...")end;A(mspPollReply())return 0 end;return{run=run_ui}
