local a=68;local b=250;local c=80;local d=2;local e=3;local f=4;local g=5;local h=d;local i=1;local j=1;local k=0;local l=0;local m=0;local n=0;local o=false;backgroundFill=backgroundFill or ERASE;foregroundColor=foregroundColor or SOLID;globalTextOptions=globalTextOptions or 0;local function p(q)local r=SetupPages[i]if r.values then if r.preSave then r.preSave(r)end;protocol.mspWrite(r.write,r.values)k=getTime()if h==f then m=m+1 else h=f;m=0;n=protocol.saveMaxRetries or 2;l=protocol.saveTimeout or 150 end end end;local function s()SetupPages={}h=d;k=0 end;local function t()protocol.mspRead(a)s()end;local function u()protocol.mspRead(b)end;local v={{t="save page",f=p},{t="reload",f=s},{t="reboot",f=t}}local w=false;local x=false;local function y(z,A)if z==nil or A==nil then return end;local r=SetupPages[i]if z==r.write then if r.eepromWrite then u()end;o=false;return end;if z==b then if r.reboot then t()end;s()h=d;k=0;return end;if z~=r.read then return end;if#A>0 then r.values={}for B=1,#A do r.values[B]=A[B]end;if r.postLoad then r.postLoad(r)end end end;local function C()return#SetupPages[i].fields end;local function D(E)i=i+E;if i>#PageFiles then i=1 elseif i<1 then i=#PageFiles end;j=1 end;local function F(E)j=j+E;if j>C()then j=1 elseif j<1 then j=C()end end;local function G(E)x=x+E;if x>#v then x=1 elseif x<1 then x=#v end end;local function H(r)if r.read and(r.reqTS==nil or r.reqTS+c<=getTime())then r.reqTS=getTime()protocol.mspRead(r.read)end end;function drawScreenTitle(I)lcd.drawFilledRectangle(0,0,LCD_W,10)lcd.drawText(1,1,I,INVERS)end;local function J(r,K)local I=r.title;drawScreenTitle("Betaflight / "..I)for B=1,#r.text do local L=r.text[B]if L.to==nil then lcd.drawText(L.x,L.y,L.t,globalTextOptions)else lcd.drawText(L.x,L.y,L.t,L.to)end end;local M="---"for B=1,#r.fields do local L=r.fields[B]local N=L.to or globalTextOptions;local O=N;local P=N;if B==j then P=N+INVERS;if h==e then P=P+BLINK end end;local Q=20;if L.t~=nil then lcd.drawText(L.x,L.y,L.t,O)if L.sp~=nil then Q=L.sp end else Q=0 end;if r.values then if(#r.values or 0)>=r.minBytes then if not L.value and L.vals then for R=1,#L.vals do L.value=bit32.bor(L.value or 0,bit32.lshift(r.values[L.vals[R]],(R-1)*8))end;L.value=L.value/(L.scale or 1)end end end;M="---"if L.value then if L.upd and r.values then L.upd(r)end;M=L.value;if L.table and L.table[L.value]then M=L.table[L.value]end end;lcd.drawText(L.x+Q,L.y,M,P)end end;local function S(M,T,U)if M<T then M=T elseif M>U then M=U end;return M end;local function V()local r=SetupPages[i]return r.fields[j]end;local function W(E)local r=SetupPages[i]local L=r.fields[j]local R=L.i or j;local X=L.scale or 1;L.value=S(L.value+E*(L.mult or 1)/X,L.min/X or 0,L.max/X or 255)for R=1,#L.vals do r.values[L.vals[R]]=bit32.rshift(L.value*X,(R-1)*8)end;if L.upd and r.values then L.upd(r)end end;local function Y()local Z=MenuBox.x;local _=MenuBox.y;local a0=MenuBox.w;local a1=MenuBox.h_line;local a2=MenuBox.h_offset;local a3=#v*a1+a2*2;lcd.drawFilledRectangle(Z,_,a0,a3,backgroundFill)lcd.drawRectangle(Z,_,a0-1,a3-1,foregroundColor)lcd.drawText(Z+a1/2,_+a2,"Menu:",globalTextOptions)for B,a4 in ipairs(v)do local N=globalTextOptions;if x==B then N=N+INVERS end;lcd.drawText(Z+MenuBox.x_offset,_+(B-1)*a1+a2,a4.t,N)end end;local a5=0;local a6=0;function run_ui(a7)local a8=getTime()if a5+50<a8 then s()end;a5=a8;if h==f then if k+l<a8 then if m<n then p()else h=d;s()end end end;mspProcessTxQ()if a7==EVT_MENU_LONG then x=1;h=g elseif EVT_PAGEUP_FIRST and a7==EVT_ENTER_LONG then x=1;a6=1;h=g elseif h==g then if a7==EVT_EXIT_BREAK then h=d elseif a7==EVT_PLUS_BREAK or a7==EVT_ROT_LEFT then G(-1)elseif a7==EVT_MINUS_BREAK or a7==EVT_ROT_RIGHT then G(1)elseif a7==EVT_ENTER_BREAK then if a6==1 then a6=0 else h=d;v[x].f()end end elseif h<=d then if a7==EVT_PAGEUP_FIRST then SetupPages[i]=nil;D(-1)elseif a7==EVT_MENU_BREAK or a7==EVT_PAGEDN_FIRST then SetupPages[i]=nil;D(1)elseif a7==EVT_PLUS_BREAK or a7==EVT_ROT_LEFT then F(-1)elseif a7==EVT_MINUS_BREAK or a7==EVT_ROT_RIGHT then F(1)elseif a7==EVT_ENTER_BREAK then local r=SetupPages[i]local a9=r.fields[j]local R=a9.i or j;if r.values and r.values[R]and a9.ro~=true then h=e end elseif a7==EVT_EXIT_BREAK then return protocol.exitFunc()end elseif h==e then if a7==EVT_EXIT_BREAK or a7==EVT_ENTER_BREAK then h=d elseif a7==EVT_PLUS_FIRST or a7==EVT_PLUS_REPT or a7==EVT_ROT_RIGHT then W(1)elseif a7==EVT_MINUS_FIRST or a7==EVT_MINUS_REPT or a7==EVT_ROT_LEFT then W(-1)end end;if SetupPages[i]==nil then SetupPages[i]=assert(loadScript(radio.templateHome..PageFiles[i]))()end;local K=false;local r=SetupPages[i]if not r.values and h==d then H(r)K=true end;lcd.clear()if TEXT_BGCOLOR then lcd.drawFilledRectangle(0,0,LCD_W,LCD_H,TEXT_BGCOLOR)end;J(r,K)if protocol.rssi()==0 then lcd.drawText(NoTelem[1],NoTelem[2],NoTelem[3],NoTelem[4])end;if h==g then Y()elseif h==f then lcd.drawFilledRectangle(SaveBox.x,SaveBox.y,SaveBox.w,SaveBox.h,backgroundFill)lcd.drawRectangle(SaveBox.x,SaveBox.y,SaveBox.w,SaveBox.h,SOLID)lcd.drawText(SaveBox.x+SaveBox.x_offset,SaveBox.y+SaveBox.h_offset,"Saving...",DBLSIZE+BLINK+globalTextOptions)end;y(mspPollReply())return 0 end;return run_ui
