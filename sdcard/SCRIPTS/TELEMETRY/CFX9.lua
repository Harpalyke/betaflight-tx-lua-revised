assert(loadScript("/SCRIPTS/BF/ui_crsf.lua"))()logFile="/SCRIPTS/BF/crsfOut.log"MenuBox={x=40,y=12,w=120,x_offset=36,h_line=8,h_offset=3}SaveBox={x=40,y=12,w=120,x_offset=4,h=30,h_offset=5}NoTelem={70,55,"No Telemetry",BLINK}menuStates={["Crossfire"]=1,["Betaflight"]=2}currentMenuState=1;debug=false;local a={}local b=1;local c=0;local function d(e,f)local g={id=e,name=f,timeout=0}return g end;local function h(f)for i=1,#a do if a[i].name==f then return a[i]end end;return nil end;local function j(k)local e=k[2]local f=""local i=3;while k[i]~=0 do f=f..string.char(k[i])i=i+1 end;local g=h(f)if g==nil then g=d(e,f)a[#a+1]=g end;local l=getTime()g.timeout=l+3000;if b==0 then b=1 end end;local m=0;local function n()local o,k=crossfireTelemetryPop()if o==nil then local l=getTime()if l>m then m=l+100;crossfireTelemetryPush(0x28,{0x00,0xEA})end elseif o==0x29 then j(k)end end;local function p(q)b=1+(b+q-1+#a)%#a end;local function r()b=0;c=0;currentMenuState=1;if debug then local g=d(0xC8,"Betaflight")a[#a+1]=g end end;local function s(t)if currentMenuState==menuStates["Crossfire"]then if t==nil then error("Cannot be run as a model script!")return 2 elseif t==EVT_EXIT_BREAK then return 2 elseif t==EVT_PLUS_FIRST or t==EVT_PLUS_REPT then p(-1)elseif t==EVT_MINUS_FIRST or t==EVT_MINUS_REPT then p(1)end;lcd.clear()lcd.drawFilledRectangle(0,0,LCD_W,10)lcd.drawText(1,1,"Crossfire Setup",INVERS)if#a==0 then lcd.drawText(24,28,"Waiting for Crossfire devices...")else for i=1,#a do local u=b==i and INVERS or 0;if t==EVT_ENTER_BREAK and u==INVERS then if a[i].id==0xC8 then currentMenuState=menuStates["Betaflight"]break else crossfireTelemetryPush(0x28,{a[i].id,0xEA})return"device.lua"end end;lcd.drawText(0,i*8+9,a[i].name,u)end end;n()return 0 else return run_bf_ui(t)end end;return{init=r,run=s}
